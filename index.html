<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Canvas Assistant</title>
  <style>
    :root {
      --brand-purple: #5D3FD3;
      --accent-teal: #1ABC9C;
      --bg: #F7F7FA;
      --text: #1b1b1f;
      --muted: #737373;
      --bubble-user: #E8F8F5; /* light teal tint */
      --bubble-bot: #ffffff;
      --border: #e7e7ee;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--brand-purple);
      color: #fff;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      height: calc(100dvh - 64px);
      padding: 8px 12px;
      gap: 8px;
    }
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .bubble {
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      border: 1px solid var(--border);
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .bot { align-self: flex-start; background: var(--bubble-bot); }
    .user { align-self: flex-end; background: var(--bubble-user); }
    .meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .controls {
      display: flex;
      gap: 8px;
      border-top: 1px solid var(--border);
      padding: 10px 8px;
      background: #fff;
      border-radius: 12px;
    }
    .controls input[type="text"] {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    .controls button {
      background: var(--accent-teal);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0 16px;
      font-weight: 600;
      cursor: pointer;
      min-width: 84px;
      transition: filter .15s ease;
    }
    .controls button:disabled { filter: grayscale(0.3) opacity(0.7); cursor: not-allowed; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
    .chip {
      background: #e9f9f5;
      border: 1px solid #d2f1e9;
      color: #0a3d34;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }
    .footer-note { text-align: center; color: var(--muted); font-size: 12px; padding: 8px 0 16px; }
    .actions { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
    .link { color: var(--brand-purple); text-decoration: underline; cursor: pointer; font-size: 12px; }
  </style>
</head>
<body>
  <header>Canvas Assistant</header>
  <main class="container" role="main">
    <section id="chat" class="chat" aria-live="polite" aria-label="Chat messages"></section>
    <form id="composer" class="controls" autocomplete="off">
      <input id="message" type="text" placeholder="Ask about invoices, expenses, Tax Jarâ€¦" aria-label="Your message" required />
      <button id="send" type="submit">Send</button>
    </form>
    <div class="footer-note">Canvas Assistant offers general guidance, not legal or tax advice.</div>
  </main>

  <script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('composer');
    const input = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    // Dynamically target local Flask server in development
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:3000'
      : '';

    let conversationContext = { lastIntent: undefined, lastStep: undefined };

    function scrollToBottom() { chat.scrollTop = chat.scrollHeight; }

    function bubble(content, role = 'bot', { suggestions = [], rationale = null } = {}) {
      const wrap = document.createElement('div');
      wrap.className = `bubble ${role}`;
      wrap.textContent = content;
      chat.appendChild(wrap);

      if (role === 'bot') {
        const actions = document.createElement('div');
        actions.className = 'actions';
        // Feedback controls (no-op)
        const up = document.createElement('span'); up.textContent = 'ðŸ‘'; up.title = 'Helpful'; up.style.cursor='pointer';
        const down = document.createElement('span'); down.textContent = 'ðŸ‘Ž'; down.title = 'Not helpful'; down.style.cursor='pointer';
        up.onclick = () => console.log('feedback: up');
        down.onclick = () => console.log('feedback: down');
        actions.appendChild(up); actions.appendChild(down);

        if (rationale) {
          const why = document.createElement('span');
          why.className = 'link';
          why.textContent = 'Why this?';
          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.style.display = 'none';
          meta.textContent = rationale;
          why.onclick = () => { meta.style.display = meta.style.display === 'none' ? 'block' : 'none'; };
          actions.appendChild(why);
          wrap.appendChild(meta);
        }

        if (suggestions && suggestions.length) {
          const chips = document.createElement('div');
          chips.className = 'chips';
          suggestions.forEach(s => {
            const c = document.createElement('button');
            c.type = 'button';
            c.className = 'chip';
            c.textContent = s;
            c.onclick = () => {
              input.value = s;
              form.dispatchEvent(new Event('submit'));
            };
            chips.appendChild(c);
          });
          wrap.appendChild(chips);
        }

        wrap.appendChild(actions);
      }

      scrollToBottom();
      return wrap;
    }

    function showTyping() {
      const typing = document.createElement('div');
      typing.className = 'bubble bot';
      typing.textContent = 'Typingâ€¦';
      typing.setAttribute('aria-live', 'polite');
      chat.appendChild(typing);
      scrollToBottom();
      return typing;
    }

    async function sendMessage(text) {
      if (!text) return;
      bubble(text, 'user');
      input.value = '';
      input.focus();
      sendBtn.disabled = true;
      const typing = showTyping();
      try {
        const res = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, context: conversationContext })
        });
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();
        typing.remove();
        bubble(data.response, 'bot', { suggestions: data.suggestions, rationale: data.rationale });
        conversationContext.lastIntent = data.followUpIntent || data.intent;
      } catch (e) {
        typing.remove();
        bubble("Sorry, I couldn't reach the assistant. Please try again.", 'bot');
        console.error(e);
      } finally {
        sendBtn.disabled = false;
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      sendMessage(input.value.trim());
    });

    // Seed greeting
    bubble("Hello! I'm the Canvas Assistant. How can I help you with your freelance finances today?", 'bot', { suggestions: ["About Canvas", "Invoices", "Tax Jar"] });
    input.focus();
  </script>
</body>
<!-- Canvas Assistant -->
</html>


